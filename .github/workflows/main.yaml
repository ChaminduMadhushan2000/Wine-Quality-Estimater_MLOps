name: MLOps Project CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Get code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed so we can git commit/push from CI

      # 2) Python + pip cache
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # 3) Install dependencies (code + DVC + S3 support)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas scikit-learn mlflow numpy joblib fastapi uvicorn
          pip install "dvc[s3]"

      # 4) Configure AWS credentials for DVC S3 remote
      #    Make sure you set AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION
      #    in your GitHub repo -> Settings -> Secrets and variables -> Actions
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 5) Pull latest data/model tracked by DVC from S3
      - name: DVC pull data and model
        run: dvc pull

      # 6) Train model (this will overwrite model.joblib)
      - name: Train model
        run: python train.py

      # 7) Track updated model with DVC
      - name: DVC add model artifact
        run: |
          dvc add model.joblib
          git add model.joblib.dvc .gitignore
          git status

      # 8) Commit DVC metadata (if there are changes)
      - name: Commit DVC changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update model from CI pipeline" || echo "No changes to commit"

      # 9) Push DVC metadata back to GitHub
      - name: Push changes to GitHub
        run: git push

      # 10) Push data/model blobs to S3 via DVC remote
      - name: DVC push data and model to S3
        run: dvc push

      # 11) Build Docker image for the API using the latest model
      - name: Build docker image
        run: docker build -t wine-model:latest .
